package com.example.cinema;

import org.springframework.web.bind.annotation.*;
import org.springframework.core.io.ClassPathResource;
import org.springframework.http.ResponseEntity;
import org.springframework.http.MediaType;
import java.util.*;
import com.example.cinema.model.Film;
import com.example.cinema.model.News;
import java.nio.file.Files;

/**
 * REST controller exposing in-memory data for films, releases, news and images.
 * CORS is enabled for frontend development.
 */
@RestController
@CrossOrigin(origins = "*")
@RequestMapping("/api")
public class ApiController {

    private List<Film> films = new ArrayList<>();
    private List<News> newsPool = new ArrayList<>();

    // Initialize in-memory data
    public ApiController() {
        films.add(new Film(1L,"The Godfather",1972,"USA","Francis Ford Coppola","drammatico","the_godfather_thumbnail.jpg","the_godfather_screenshot.jpg",
                "Anni Quaranta. Come è consuetudine, durante il rinfresco per festeggiare le nozze della figlia Conny con Carlo, il \"padrino\" don Vito Corleone promette assistenza e protezione a familiari e amici. Invia il figliastro Tom Hagen in California per convincere in ogni modo il produttore Jack Woltz a scritturare il cantante Johnny nel suo prossimo film. Woltz non acconsente. Tom allora lo costringe ad accettare con un \"avvertimento\": l'uccisione del suo cavallo di razza preferito. Sollozzo, a nome della potente \"famiglia\" Tartaglia, chiede a Corleone finanziamenti e appoggi per il traffico di droga. Il rifiuto scatena una lotta cruenta tra le due cosche: lo stesso don Vito viene ferito gravemente; il figlio minore Michael lo salva da un secondo attentato. Michael, poi, scavalcando l'irruento fratello Sonny e Tom, temporeggiatore, organizza un incontro con Sollozzo e con il corrotto capitano di polizia McCluskey uccidendoli entrambi.","1972-03-24"));
        films.add(new Film(2L,"Schindler's List",1993,"USA","Steven Spielberg","drammatico","schindler_thumbnail.jpg","schindler_screenshot.jpg",
                "Cracovia, 1939. L'industriale tedesco Oskar Schindler, bella presenza e temperamento avventuroso, manovrando i vertici nazisti tenta di rilevare un fabbrica per produrre pignatte e marmitte. Già reclusi nel ghetto di Podgorze, ed impossibilitati a commerciare, alcuni ebrei vengono convinti da Schindler a fornire il denaro per rilevare l'edificio: li ripagherà impiegandoli nella fabbrica, pagandoli con utensili da scambiare e sottraendoli al campo di lavoro comandato dal sadico criminale tedesco Amon Goeth. Dopo aver ricevuto la breve visita di Emilie, la moglie che subito torna in Moravia vista la vita di libertino impenitente del marito, Schindler, sempre più nelle grazie dell'alto comando nazista e di Goeth, costruisce un campo per i suoi operai, dove le milizie non possono entrare senza la sua autorizzazione. Infine, scatenatosi lo sterminio, decide di attivare, dando fondo a tutte le sue risorse finanziarie, una fabbrica di granate nella natia Brinnlitz. Con l'aiuto dell'inseparabile Itzhak Stern, il contabile ebreo, compila una lista di 1100 persone ebree perché vengano a lui affidate come operai. Mentre gli uomini arrivano a destinazione, le donne vengono per errore tradotte ad Auschwitz, e solo con grande rischio ed impiegando a fondo risorse e conoscenze, Schindler riesce a strapparle alla morte. Per sette mesi la fabbrica produce appositamente granate difettose, finché l'armistizio non trova l'industriale senza denaro. I suoi operai gli donano un anello d'oro con su incisa una frase del Talmud: \"Chiunque salva una vita salva il mondo intero\".","1993-12-15"));
        films.add(new Film(3L,"Atonement",2007,"UK","Joe Wright","drammatico","atonement_thumbnail.jpg","atonement_screenshot.jpg",
                "La giovane Bryoni Tallis a soli tredici anni ha già una forte passione per la scrittura e una vivida immaginazione. E questa passione la porterà a commettere un atto che rovinerà la vita di sua sorella Cecilia e del suo giovane innamorato Robbie Turner, figlio della governante, che verrà ingiustamente accusato di violenza sessuale. Nel corso della sua vita Bryoni cercherà di espiare la sua colpa scrivendo un romanzo per raccontare la verità sui fatti accaduti...","2007-09-07"));
        films.add(new Film(4L,"The Notebook",2004,"USA","Nick Cassavetes","sentimentale","notebook_thumbnail.jpg","notebook_screenshot.jpg",
                "In una casa di riposo, un uomo anziano sta leggendo a una donna, anche lei anziana, pagine sbiadite dal tempo di vecchi quaderni di appunti. Le sta narrando la storia di due giovani innamorati, Noah Calhoun e Allie Hamilton. Dopo una splendida estate passata insieme, Noah e Allie, provenienti da ceti sociali differenti, sono costretti a separarsi poiché i genitori di lei non approvano i loro sentimenti. Nel frattempo scoppia la Seconda Guerra Mondiale, Noah parte per il fronte e Allie, non ricevendo alcuna notizia dal suo innamorato, si fidanza con Lon, un giovane benestante che piace molto alla sua famiglia. Finita la guerra Noah torna a casa e decide di restaurare un'antica casa per accogliere Allie, se lei lo vorrà. La ragazza però, si trova a dover scegliere tra contraddire i desideri dei suoi genitori o seguire il suo cuore...","2004-06-25"));
        films.add(new Film(5L,"Blue Valentine",2010,"USA","Derek Cianfrance","sentimentale","blue_valentine_thumbnail.jpg","blue_valentine_screenshot.jpg",
                "Blue Valentine racconta la particolare storia d’amore di Dean (Ryan Gosling) e Cindy (Michelle Williams). Lui ha lasciato gli studi molto presto e ha deciso di fare il traslocatore per una compagnia di Brooklyn; lei, invece, studia per diventare medico e abita ancora a casa dei suoi genitori, occupandosi anche di sua nonna. È proprio nell’ospizio dove l’anziana è ricoverata in Pennsylvania che i due si conoscono. Tra loro nasce subito una forte attrazione che li porta a frequentarsi e a cominciare una relazione.\n"
                + "Qualche tempo dopo la ragazza confida a Dean di aspettare un bambino, ma di non essere sicura che il padre sia lui. Il figlio potrebbe essere del suo ex, Bobby (Mike Vogel), un tipo violento con il quale non era stata particolarmente attenta. Se in un primo momento Cindy decide di abortire, alla fine sceglie di portare avanti la gravidanza. Dean è talmente innamorato di lei che vuole sposarla comunque, anche se il bimbo che porta in grembo potrebbe non avere il suo stesso dna. Le cose si complicano quando Bobby scopre della loro relazione e, in un impeto di rabbia, picchia ferocemente Dean…","2010-12-31"));
        films.add(new Film(6L,"La La Land",2016,"USA","Damien Chazelle","sentimentale","lalaland_thumbnail.jpg","lalaland_screenshot.jpg",
                "L'intensa e burrascosa storia d'amore tra un'attrice e un musicista che si sono appena trasferiti a Los Angeles in cerca di fortuna. Mia è un'aspirante attrice che, tra un provino e l'altro, serve cappuccini alle star del cinema. Sebastian è un musicista jazz che sbarca il lunario suonando nei piano bar. Dopo alcuni incontri casuali, fra Mia e Sebastian esplode una travolgente passione nutrita dalla condivisione di aspirazioni comuni, da sogni intrecciati e da una complicità fatta di incoraggiamento e sostegno reciproco. Ma quando iniziano ad arrivare i primi successi, i due si dovranno confrontare con delle scelte che metteranno in discussione il loro rapporto. La minaccia più grande sarà rappresentata proprio dai sogni che condividono e dalle loro ambizioni professionali.","2016-12-09"));

     // 12 articoli realistici e completi
        newsPool.add(new News(
            1L,
            "Primo trailer di *Eclipse*: il thriller sci-fi che sta facendo impazzire il web",
            "news1_thumbnail.jpg",
            "Il primo trailer di *Eclipse* ha immediatamente catalizzato l’attenzione degli appassionati del genere. "
          + "Atmosfere cupe, una fotografia ricercata e un ritmo serrato dominano i 120 secondi del filmato, "
          + "anticipando un’opera che sembra voler unire tensione psicologica e fantascienza di alto livello. "
          + "Il protagonista, interpretato da Noah Carter, si trova intrappolato in una realtà che si piega e si deforma "
          + "attorno ai suoi ricordi. La regia di Maya Henders offre una combinazione di virtuosismi tecnici e narrazione "
          + "minimalista che sta già conquistando la critica. (testo esteso)"
        ));

        newsPool.add(new News(
            2L,
            "Il Festival di Venezia celebra le nuove voci del cinema indipendente",
            "news2_thumbnail.jpg",
            "L’edizione di quest’anno del Festival di Venezia ha deciso di dedicare un’intera sezione alle opere prime "
          + "e ai giovani autori emergenti. Molti film presentati hanno affrontato temi sociali complessi con grande sensibilità, "
          + "ricevendo standing ovation e recensioni entusiastiche. Particolare attenzione è stata riservata a *Luce Nascosta*, "
          + "un dramma familiare diretto da Giulia Vanni che ha stupito per la maturità stilistica nonostante il budget ridotto. "
          + "La critica parla di una nuova generazione di registi pronti a rivoluzionare il panorama europeo. (testo esteso)"
        ));

        newsPool.add(new News(
            3L,
            "Collaborazione inattesa: Sorrentino e Villeneuve lavorano a un progetto congiunto",
            "news3_thumbnail.jpg",
            "L’annuncio ha lasciato tutti sorpresi: Paolo Sorrentino e Denis Villeneuve uniranno le forze per un film drammatico "
          + "di ambientazione storica. Secondo le prime indiscrezioni, il progetto unirà lo stile poetico e surreale di Sorrentino "
          + "alla precisione visiva e narrativa di Villeneuve. Il film sarà ambientato nel dopoguerra europeo e racconterà la storia "
          + "di due uomini legati da un segreto che potrebbe cambiare il corso della politica internazionale. Le riprese inizieranno "
          + "nel 2025. (testo esteso)"
        ));

        newsPool.add(new News(
            4L,
            "Netflix adatta il bestseller mondiale *La Città delle Nebbie*",
            "news4_thumbnail.jpg",
            "Il colosso dello streaming ha confermato l’adattamento del romanzo *La Città delle Nebbie*, campione di vendite "
          + "in 42 paesi. La serie, composta da otto episodi, esplorerà intrighi politici, misteri sovrannaturali e dramma umano. "
          + "Nel cast figurano Emma Roberts e il francese Louis Garrel. L’autrice del romanzo, Claire Duvall, ha dichiarato che "
          + "l’adattamento «è sorprendentemente fedele, con alcune scelte visive che migliorano perfino il libro». (testo esteso)"
        ));

        newsPool.add(new News(
            5L,
            "Realtà virtuale e set digitali: così cambia il futuro degli effetti speciali",
            "news5_thumbnail.jpg",
            "Le nuove tecnologie di virtual production stanno rivoluzionando completamente il modo di realizzare film. "
          + "Grazie agli stage LED e alla simulazione in tempo reale, gli attori possono muoversi in ambienti generati "
          + "digitalmente con un realismo mai visto prima. Molti registi parlano di una ‘terza rivoluzione visiva’, "
          + "capace di ridurre i costi senza sacrificare la qualità. Gli esperti prevedono che entro cinque anni "
          + "questa tecnica diventerà la norma. (testo esteso)"
        ));

        newsPool.add(new News(
            6L,
            "Intervista esclusiva a Sofia Moretti: «Questo ruolo mi ha cambiata»",
            "news6_thumbnail.jpg",
            "L’attrice italiana Sofia Moretti, protagonista del nuovo film *Oltre il Silenzio*, racconta come il ruolo "
          + "di una ricercatrice affetta da un disturbo neurologico l’abbia messa alla prova come mai prima. "
          + "«Ho dovuto studiare a lungo, incontrare pazienti reali, capire le loro paure e la loro forza», dichiara. "
          + "Il film, diretto da Riccardo Balestri, è già in corsa per diversi premi internazionali. (testo esteso)"
        ));

        newsPool.add(new News(
            7L,
            "L’intelligenza artificiale arriva sul set: tra opportunità e timori",
            "news7_thumbnail.jpg",
            "Sempre più produzioni stanno utilizzando sistemi di AI per storyboard automatici, pre-visualizzazioni interattive "
          + "e perfino editing preliminare. Se da un lato queste tecnologie accelerano i tempi di lavorazione, dall’altro "
          + "alcuni professionisti temono che possano sostituire figure creative essenziali. Le associazioni di categoria "
          + "chiedono regolamenti chiari per tutelare i lavoratori. (testo esteso)"
        ));

        newsPool.add(new News(
            8L,
            "Retrospettiva dedicata a Hayao Miyazaki conquista la critica",
            "news8_thumbnail.jpg",
            "La nuova retrospettiva dedicata al maestro dell’animazione Hayao Miyazaki ha richiamato migliaia di visitatori. "
          + "Oltre ai lungometraggi più celebri, l’esposizione include schizzi originali, materiali di produzione e interviste "
          + "inedite. La mostra mette in luce il metodo creativo del regista e la sua ossessione per il dettaglio, "
          + "ispirando una nuova generazione di animatori. (testo esteso)"
        ));

        newsPool.add(new News(
            9L,
            "Roma ospita la premiere europea di *Falling Skies*",
            "news9_thumbnail.jpg",
            "Il red carpet romano ha visto sfilare l’intero cast del nuovo film fantasy *Falling Skies*. Migliaia di fan "
          + "si sono radunati fuori dal teatro per assistere all’evento. Il regista Alejandro Torres ha dichiarato: "
          + "«Questo film è una lettera d’amore all’immaginazione». Dopo la proiezione, la critica ha elogiato gli effetti "
          + "speciali e la colonna sonora epica. (testo esteso)"
        ));

        newsPool.add(new News(
            10L,
            "Colonna sonora di *Silent Horizon* candidata a tre premi internazionali",
            "news10_thumbnail.jpg",
            "La soundtrack composta da Haru Matsuda per *Silent Horizon* ha ricevuto tre nomination, tra cui Miglior "
          + "Colonna Sonora Originale ai World Film Awards. L’uso di strumenti elettronici combinati con melodie orchestrali "
          + "ha creato un sound unico, capace di evocare un’atmosfera sospesa. Il film stesso sta ottenendo ottimi risultati "
          + "al botteghino. (testo esteso)"
        ));

        newsPool.add(new News(
            11L,
            "Documentario *Senza Confini* emoziona pubblico e critica",
            "news11_thumbnail.jpg",
            "Il documentario *Senza Confini* racconta la storia di tre volontari impegnati nelle zone più fragili del mondo. "
          + "Il film è stato accolto con grande entusiasmo al Torino Film Festival grazie al suo realismo potente e "
          + "alla fotografia evocativa. Molti analisti lo indicano già tra i favoriti nella categoria documentari. (testo esteso)"
        ));

        newsPool.add(new News(
            12L,
            "Nuove sale immersive IMAX aprono in tutta Italia",
            "news12_thumbnail.jpg",
            "Con una crescita del settore cinematografico italiano, diverse città inaugureranno nuove sale IMAX "
          + "dotate di sistemi audio 12.1 e schermi a curvatura dinamica. L’obiettivo è rilanciare l’esperienza "
          + "cinematografica in sala dopo anni difficili per il settore. Gli spettatori potranno vivere film d’azione "
          + "e fantascienza con un livello di immersione senza precedenti. (testo esteso)"
        ));

    }

    // Return films grouped by genre
    @GetMapping("/genres")
    public Map<String, List<Film>> getByGenre() {
        Map<String, List<Film>> map = new HashMap<>();
        map.put("drammatico", new ArrayList<>());
        map.put("sentimentale", new ArrayList<>());
        for(Film f: films){
            if("drammatico".equalsIgnoreCase(f.genre)) map.get("drammatico").add(f);
            if("sentimentale".equalsIgnoreCase(f.genre)) map.get("sentimentale").add(f);
        }
        return map;
    }

    // Return film by id
    @GetMapping("/films/{id}")
    public Film getFilm(@PathVariable Long id){
        return films.stream().filter(f->f.id.equals(id)).findFirst().orElse(null);
    }

    // Releases grouped by relative weeks
    @GetMapping("/releases")
    public Map<String, List<Film>> getReleases(){
        Map<String, List<Film>> r = new HashMap<>();
        r.put("previous", Arrays.asList(films.get(0), films.get(1)));
        r.put("this", Arrays.asList(films.get(2), films.get(3)));
        r.put("week1", Arrays.asList(films.get(4), films.get(5)));
        r.put("week2", Arrays.asList(films.get(1), films.get(4)));
        r.put("week3", Arrays.asList(films.get(0), films.get(5)));
        return r;
    }

    // Return 3 random news from pool
    @GetMapping("/news")
    public List<News> getRandomNews(){
        Collections.shuffle(newsPool);
        return newsPool.subList(0,3);
    }

    // Serve images from classpath resources/static/images
    @GetMapping(value = "/images/{name}")
    public ResponseEntity<byte[]> getImage(@PathVariable String name) throws Exception {
        ClassPathResource imgFile = new ClassPathResource("static/images/" + name);
        if(!imgFile.exists()) return ResponseEntity.notFound().build();
        byte[] bytes = Files.readAllBytes(imgFile.getFile().toPath());
        return ResponseEntity.ok().contentType(MediaType.IMAGE_JPEG).body(bytes);
    }
}
