package com.example.cinema;

import org.springframework.web.bind.annotation.*;
import org.springframework.core.io.ClassPathResource;
import org.springframework.http.ResponseEntity;
import org.springframework.http.MediaType;
import java.util.*;
import com.example.cinema.model.Film;
import com.example.cinema.model.News;
import java.nio.file.Files;

/**
 * REST controller exposing in-memory data for films, releases, news and images.
 * CORS is enabled for frontend development.
 */
@RestController
@CrossOrigin(origins = "*")
@RequestMapping("/api")
public class ApiController {

    private List<Film> films = new ArrayList<>();
    private List<News> newsPool = new ArrayList<>();

    // Initialize in-memory data
    public ApiController() {
        films.add(new Film(1L,"The Godfather",1972,"USA","Francis Ford Coppola","drammatico","the_godfather_thumbnail.jpg","the_godfather_screenshot.jpg",
                "La storia della famiglia mafiosa dei Corleone e la lotta per il potere tra le generazioni.","1972-03-24"));
        films.add(new Film(2L,"Schindler's List",1993,"USA","Steven Spielberg","drammatico","schindler_thumbnail.jpg","schindler_screenshot.jpg",
                "Racconto di Oskar Schindler che salvò oltre mille persone durante l'Olocausto.","1993-12-15"));
        films.add(new Film(3L,"Atonement",2007,"UK","Joe Wright","drammatico","atonement_thumbnail.jpg","atonement_screenshot.jpg",
                "Una storia d'amore, senso di colpa e redenzione che attraversa decenni.","2007-09-07"));
        films.add(new Film(4L,"The Notebook",2004,"USA","Nick Cassavetes","sentimentale","notebook_thumbnail.jpg","notebook_screenshot.jpg",
                "La storia d'amore tra Noah e Allie, tra ricordi e passione che dura nel tempo.","2004-06-25"));
        films.add(new Film(5L,"Blue Valentine",2010,"USA","Derek Cianfrance","sentimentale","blue_valentine_thumbnail.jpg","blue_valentine_screenshot.jpg",
                "Ritratto intimo di una relazione che si sgretola, alternando passato e presente.","2010-12-31"));
        films.add(new Film(6L,"La La Land",2016,"USA","Damien Chazelle","sentimentale","lalaland_thumbnail.jpg","lalaland_screenshot.jpg",
                "Musical romantico su ambizioni artistiche e una storia d'amore a Los Angeles.","2016-12-09"));

        // 12 news items in the pool
        newsPool.add(new News(1L,"Trailer mozzafiato del nuovo film","news1_thumbnail.jpg","Il nuovo trailer mostra scene spettacolari e una regia audace... (testo esteso)."));
        newsPool.add(new News(2L,"Festival celebra il cinema indipendente","news2_thumbnail.jpg","Il festival ha messo in luce opere di autori emergenti... (testo esteso)."));
        newsPool.add(new News(3L,"Registi annunciano progetto comune","news3_thumbnail.jpg","Due registi collaborano per un dramma storico di grande respiro... (testo esteso)."));
        newsPool.add(new News(4L,"Adattamento di un bestseller","news4_thumbnail.jpg","Un libro di successo diventa un film con cast internazionale... (testo esteso)."));
        newsPool.add(new News(5L,"Nuove frontiere degli effetti speciali","news5_thumbnail.jpg","Tecniche innovative stanno trasformando il linguaggio visivo del cinema... (testo esteso)."));
        newsPool.add(new News(6L,"Intervista esclusiva alla protagonista","news6_thumbnail.jpg","L'attrice racconta il suo approccio al ruolo e le sfide affrontate... (testo esteso)."));
        newsPool.add(new News(7L,"Cinema e tecnologia: l'AI on set","news7_thumbnail.jpg","L'uso dell'intelligenza artificiale nelle fasi di produzione cresce... (testo esteso)."));
        newsPool.add(new News(8L,"Retrospettiva su un grande regista","news8_thumbnail.jpg","Una rassegna rilegge l'opera di un maestro del cinema... (testo esteso)."));
        newsPool.add(new News(9L,"Premiere europea a Roma","news9_thumbnail.jpg","La premiere vedrà la partecipazione del cast e numerosi eventi collaterali... (testo esteso)."));
        newsPool.add(new News(10L,"Colonna sonora nominata ai premi","news10_thumbnail.jpg","La colonna sonora riceve lodi e nomination in festival internazionali... (testo esteso)."));
        newsPool.add(new News(11L,"Documentario conquista il pubblico","news11_thumbnail.jpg","Un documentario toccante ottiene riconoscimenti e attenzione mediatica... (testo esteso)."));
        newsPool.add(new News(12L,"Nuovi cinema rinnovano l'esperienza","news12_thumbnail.jpg","Progetti di ristrutturazione portano nuove sale e tecnologie immersive... (testo esteso)."));
    }

    // Return films grouped by genre
    @GetMapping("/genres")
    public Map<String, List<Film>> getByGenre() {
        Map<String, List<Film>> map = new HashMap<>();
        map.put("drammatico", new ArrayList<>());
        map.put("sentimentale", new ArrayList<>());
        for(Film f: films){
            if("drammatico".equalsIgnoreCase(f.genre)) map.get("drammatico").add(f);
            if("sentimentale".equalsIgnoreCase(f.genre)) map.get("sentimentale").add(f);
        }
        return map;
    }

    // Return film by id
    @GetMapping("/films/{id}")
    public Film getFilm(@PathVariable Long id){
        return films.stream().filter(f->f.id.equals(id)).findFirst().orElse(null);
    }

    // Releases grouped by relative weeks
    @GetMapping("/releases")
    public Map<String, List<Film>> getReleases(){
        Map<String, List<Film>> r = new HashMap<>();
        r.put("previous", Arrays.asList(films.get(0), films.get(1)));
        r.put("this", Arrays.asList(films.get(2), films.get(3)));
        r.put("week1", Arrays.asList(films.get(4), films.get(5)));
        r.put("week2", Arrays.asList(films.get(1), films.get(4)));
        r.put("week3", Arrays.asList(films.get(0), films.get(5)));
        return r;
    }

    // Return 3 random news from pool
    @GetMapping("/news")
    public List<News> getRandomNews(){
        Collections.shuffle(newsPool);
        return newsPool.subList(0,3);
    }

    // Serve images from classpath resources/static/images
    @GetMapping(value = "/images/{name}")
    public ResponseEntity<byte[]> getImage(@PathVariable String name) throws Exception {
        ClassPathResource imgFile = new ClassPathResource("static/images/" + name);
        if(!imgFile.exists()) return ResponseEntity.notFound().build();
        byte[] bytes = Files.readAllBytes(imgFile.getFile().toPath());
        return ResponseEntity.ok().contentType(MediaType.IMAGE_JPEG).body(bytes);
    }
}
