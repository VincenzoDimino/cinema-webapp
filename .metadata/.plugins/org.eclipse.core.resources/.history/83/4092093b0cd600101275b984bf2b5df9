package com.example.cinema;

import org.springframework.web.bind.annotation.*;
import org.springframework.core.io.ClassPathResource;
import org.springframework.http.ResponseEntity;
import org.springframework.http.MediaType;
import java.util.*;
import com.example.cinema.model.Film;
import com.example.cinema.model.News;
import java.nio.file.Files;

/**
 * REST controller exposing in-memory data for films, releases, news and images.
 * CORS is enabled for frontend development.
 */
@RestController
@CrossOrigin(origins = "*")
@RequestMapping("/api")
public class ApiController {

    private List<Film> films = new ArrayList<>();
    private List<News> newsPool = new ArrayList<>();

    // Initialize in-memory data
    public ApiController() {

        // -----------------------------
        //           FILM DATA
        // -----------------------------
        films.add(new Film(1L,"The Godfather",1972,"USA","Francis Ford Coppola","drammatico","the_godfather_thumbnail.jpg","the_godfather_screenshot.jpg",
                "Anni Quaranta. Come è consuetudine [...]","1972-03-24"));

        films.add(new Film(2L,"Schindler's List",1993,"USA","Steven Spielberg","drammatico","schindler_thumbnail.jpg","schindler_screenshot.jpg",
                "Cracovia, 1939. L'industriale tedesco Oskar Schindler [...]","1993-12-15"));

        films.add(new Film(3L,"Atonement",2007,"UK","Joe Wright","drammatico","atonement_thumbnail.jpg","atonement_screenshot.jpg",
                "La giovane Bryoni Tallis [...]","2007-09-07"));

        films.add(new Film(4L,"The Notebook",2004,"USA","Nick Cassavetes","sentimentale","notebook_thumbnail.jpg","notebook_screenshot.jpg",
                "In una casa di riposo [...]","2004-06-25"));

        films.add(new Film(5L,"Blue Valentine",2010,"USA","Derek Cianfrance","sentimentale","blue_valentine_thumbnail.jpg","blue_valentine_screenshot.jpg",
                "Blue Valentine racconta [...]","2010-12-31"));

        films.add(new Film(6L,"La La Land",2016,"USA","Damien Chazelle","sentimentale","lalaland_thumbnail.jpg","lalaland_screenshot.jpg",
                "L'intensa e burrascosa storia [...]","2016-12-09"));


        // -----------------------------
        //           NEWS DATA
        // -----------------------------
        newsPool.add(new News(
                1L,
                "Primo trailer di *Eclipse*: il thriller sci-fi che sta facendo impazzire il web",
                "news1_thumbnail.jpg",
                "Il primo trailer di *Eclipse* ha immediatamente catalizzato [...] (testo esteso)"
        ));

        newsPool.add(new News(
                2L,
                "Il Festival di Venezia celebra le nuove voci del cinema indipendente",
                "news2_thumbnail.jpg",
                "L’edizione di quest’anno del Festival di Venezia [...] (testo esteso)"
        ));

        newsPool.add(new News(
                3L,
                "Collaborazione inattesa: Sorrentino e Villeneuve lavorano a un progetto congiunto",
                "news3_thumbnail.jpg",
                "L’annuncio ha lasciato tutti sorpresi [...] (testo esteso)"
        ));

        newsPool.add(new News(
                4L,
                "Netflix adatta il bestseller mondiale *La Città delle Nebbie*",
                "news4_thumbnail.jpg",
                "Il colosso dello streaming ha confermato [...] (testo esteso)"
        ));

        newsPool.add(new News(
                5L,
                "Realtà virtuale e set digitali: così cambia il futuro degli effetti speciali",
                "news5_thumbnail.jpg",
                "Le nuove tecnologie di virtual production [...] (testo esteso)"
        ));

        newsPool.add(new News(
                6L,
                "Intervista esclusiva a Sofia Moretti: «Questo ruolo mi ha cambiata»",
                "news6_thumbnail.jpg",
                "L’attrice italiana Sofia Moretti [...] (testo esteso)"
        ));

        newsPool.add(new News(
                7L,
                "L’intelligenza artificiale arriva sul set: tra opportunità e timori",
                "news7_thumbnail.jpg",
                "Sempre più produzioni stanno utilizzando sistemi di AI [...] (testo esteso)"
        ));

        newsPool.add(new News(
                8L,
                "Retrospettiva dedicata a Hayao Miyazaki conquista la critica",
                "news8_thumbnail.jpg",
                "La nuova retrospettiva dedicata al maestro [...] (testo esteso)"
        ));

        newsPool.add(new News(
                9L,
                "Roma ospita la premiere europea di *Falling Skies*",
                "news9_thumbnail.jpg",
                "Il red carpet romano ha visto sfilare [...] (testo esteso)"
        ));

        newsPool.add(new News(
                10L,
                "Colonna sonora di *Silent Horizon* candidata a tre premi internazionali",
                "news10_thumbnail.jpg",
                "La soundtrack composta da Haru Matsuda [...] (testo esteso)"
        ));

        newsPool.add(new News(
                11L,
                "Documentario *Senza Confini* emoziona pubblico e critica",
                "news11_thumbnail.jpg",
                "Il documentario *Senza Confini* racconta [...] (testo esteso)"
        ));

        newsPool.add(new News(
                12L,
                "Nuove sale immersive IMAX aprono in tutta Italia",
                "news12_thumbnail.jpg",
                "Con una crescita del settore cinematografico [...] (testo esteso)"
        ));
    }


    // -----------------------------
    //           ENDPOINTS
    // -----------------------------

    // Return films grouped by genre
    @GetMapping("/genres")
    public Map<String, List<Film>> getByGenre() {
        Map<String, List<Film>> map = new HashMap<>();
        map.put("drammatico", new ArrayList<>());
        map.put("sentimentale", new ArrayList<>());
        for(Film f: films){
            if("drammatico".equalsIgnoreCase(f.genre)) map.get("drammatico").add(f);
            if("sentimentale".equalsIgnoreCase(f.genre)) map.get("sentimentale").add(f);
        }
        return map;
    }

    // Return film by ID
    @GetMapping("/films/{id}")
    public Film getFilm(@PathVariable Long id){
        return films.stream().filter(f -> f.id.equals(id)).findFirst().orElse(null);
    }

    // Releases grouped by relative weeks
    @GetMapping("/releases")
    public Map<String, List<Film>> getReleases(){
        Map<String, List<Film>> r = new HashMap<>();
        r.put("previous", Arrays.asList(films.get(0), films.get(1)));
        r.put("this", Arrays.asList(films.get(2), films.get(3)));
        r.put("week1", Arrays.asList(films.get(4), films.get(5)));
        r.put("week2", Arrays.asList(films.get(1), films.get(4)));
        r.put("week3", Arrays.asList(films.get(0), films.get(5)));
        return r;
    }

    // Return 3 random news from pool
    @GetMapping("/news")
    public List<News> getRandomNews(){
        Collections.shuffle(newsPool);
        return newsPool.subList(0,3);
    }

    // -----------------------------
    //        *** MANCAVA ***
    //   Return single news by ID
    // -----------------------------
    @GetMapping("/news/{id}")
    public News getNewsById(@PathVariable Long id){
        return newsPool.stream()
                .filter(n -> n.id.equals(id))
                .findFirst()
                .orElse(null);
    }

    // Serve images from classpath resources/static/images
    @GetMapping(value = "/images/{name}")
    public ResponseEntity<byte[]> getImage(@PathVariable String name) throws Exception {
        ClassPathResource imgFile = new ClassPathResource("static/images/" + name);
        if(!imgFile.exists()) return ResponseEntity.notFound().build();
        byte[] bytes = Files.readAllBytes(imgFile.getFile().toPath());
        return ResponseEntity.ok().contentType(MediaType.IMAGE_JPEG).body(bytes);
    }
}
